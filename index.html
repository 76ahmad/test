<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>××¢×¨×›×ª ×”×§×¦××ª ×¢×•×‘×“×™×</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2rem;
        }
        
        .header p {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .controls, .instructions {
            padding: 1rem 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        
        .calendar-container {
            overflow-x: auto;
            margin: 2rem;
        }
        
        /* Table-based calendar for better printing */
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .calendar-table th,
        .calendar-table td {
            border: 1px solid #ccc;
            padding: 12px 8px;
            text-align: center;
            vertical-align: middle;
            min-width: 100px;
        }
        
        .calendar-table th {
            background: #343a40;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .calendar-table th.corner-cell {
            font-size: 0.8rem;
            background: #343a40;
        }
        
        .calendar-table .name-cell {
            background: #212529;
            color: white;
            font-weight: bold;
            cursor: pointer;
            min-width: 120px;
        }
        
        .calendar-table .time-cell {
            background: white;
            cursor: pointer;
            transition: background 0.2s;
            min-height: 40px;
        }
        
        .calendar-table .time-cell:hover {
            background: #f8f9fa;
        }
        
        .calendar-table .time-cell.assigned {
            background: #e9ecef;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #2d2d2d;
            color: white;
            padding: 2rem;
            border-radius: 10px;
            width: 300px;
            max-width: 90%;
        }
        
        .modal-content h3 {
            margin-top: 0;
            text-align: center;
        }
        
        .place-choice {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .place-btn {
            border: 2px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: #ffffff;
            cursor: pointer;
            font-weight: bold;
            color: #333;
        }
        
        .place-btn:hover {
            border-color: #0056b3;
            background: #e2e6ea;
        }
        
        button {
            margin: 0.25rem;
            padding: 0.6rem 1.4rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s, transform 0.1s;
            background: #007bff;
            color: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }
        
        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        #assignmentSummary {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            padding: 1rem;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 8px;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.8);
            margin: 2rem;
            border-radius: 12px;
        }
        
        .instructions h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .instructions p {
            color: #666;
            line-height: 1.5;
        }
        
        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .worker-row, .place-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            padding: 0.5rem;
            border-radius: 6px;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .worker-row span, .place-row span {
            font-weight: bold;
        }
        
        .optional-label {
            font-size: 0.85em;
            color: #888;
        }

        /* Print styles - OPTIMIZED FOR MANY WORKERS */
        @page {
            size: A4 landscape;
            margin: 10mm;
        }
        
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-family: Arial, sans-serif !important;
                font-size: 9px !important;
                color: black !important;
            }
            
            .container {
                box-shadow: none !important;
                background: white !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                max-width: none !important;
            }
            
            /* Hide non-printable elements */
            .header,
            .controls, 
            .instructions,
            #assignmentSummary {
                display: none !important;
            }
            
            .calendar-container {
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
            }
            
            /* Print table styles - COMPRESSED */
            .calendar-table {
                width: 100% !important;
                border-collapse: collapse !important;
                background: white !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                page-break-inside: avoid !important;
                table-layout: fixed !important;
            }
            
            .calendar-table th,
            .calendar-table td {
                border: 1px solid black !important;
                padding: 3px 2px !important;
                text-align: center !important;
                vertical-align: middle !important;
                font-size: 8px !important;
                line-height: 1.1 !important;
                height: 18px !important;
                max-height: 18px !important;
                overflow: hidden !important;
            }
            
            .calendar-table th {
                background: #f0f0f0 !important;
                color: black !important;
                font-weight: bold !important;
                font-size: 9px !important;
                height: 20px !important;
                max-height: 20px !important;
            }
            
            .calendar-table th.corner-cell {
                font-size: 7px !important;
                background: #f0f0f0 !important;
                font-weight: bold !important;
                padding: 2px 1px !important;
            }
            
            .calendar-table .name-cell {
                background: #e0e0e0 !important;
                color: black !important;
                font-weight: bold !important;
                font-size: 8px !important;
                text-overflow: ellipsis !important;
                white-space: nowrap !important;
            }
            
            .calendar-table .time-cell {
                background: white !important;
                color: black !important;
                font-size: 7px !important;
                min-height: 18px !important;
                max-height: 18px !important;
                font-weight: normal !important;
            }
            
            .calendar-table .time-cell.assigned {
                background: #f5f5f5 !important;
                font-weight: bold !important;
                color: black !important;
            }
            
            /* Ensure proper column widths for printing - COMPRESSED */
            .calendar-table th:first-child,
            .calendar-table td:first-child {
                width: 12% !important;
                min-width: 60px !important;
                max-width: 80px !important;
            }
            
            .calendar-table th:not(:first-child),
            .calendar-table td:not(:first-child) {
                width: 12.57% !important; /* (100% - 12%) / 7 days */
            }
        }
    </style>

    <!-- SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ ××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª</h1>
            <p>× ×™×”×•×œ ××©××¨×•×ª ×¢×•×‘×“×™× ×•××§×•××•×ª ×¢×‘×•×“×”</p>
        </div>
        
        <div class="controls">
            <button onclick="saveSchedule()">ğŸ’¾ ×©××•×¨ ×§×•×‘×¥</button>
            <input accept=".json" id="fileInput" onchange="loadSchedule(event)" style="display:none" type="file"/>
            <button onclick="document.getElementById('fileInput').click()">ğŸ“‚ ×˜×¢×™× ×”</button>
            <button onclick="showAddPlaceModal()">â• ×”×•×¡×£ ××§×•×</button>
            <button onclick="showAddWorkerModal()">ğŸ‘¤ ×”×•×¡×£ ×¢×•×‘×“</button>
            <button onclick="showManagePlacesModal()">âš™ï¸ × ×”×œ ××§×•××•×ª</button>
            <button onclick="showManageWorkersModal()">ğŸ‘¥ × ×”×œ ×¢×•×‘×“×™×</button>
            <button class="btn-success" onclick="printSchedule()">ğŸ–¨ï¸ ×”×“×¤×¡×”</button>
            <button class="btn-info" onclick="exportToExcel()">ğŸ“Š ×™×¦×•× ×œ-Excel</button>
            <button class="btn-secondary" onclick="clearAssignments()">ğŸ—‘ï¸ × ×§×” ×”×§×¦××•×ª</button>
            <button class="btn-secondary" onclick="resetLocalStorage()">ğŸ”„ ××™×¤×•×¡ ××¢×¨×›×ª</button>
        </div>

        <div class="calendar-container">
            <table class="calendar-table" id="calendarTable">
                <!-- Table content will be generated by JavaScript -->
            </table>
        </div>
        
        <div id="assignmentSummary"></div>

        <div class="instructions">
            <h3>ğŸ“Œ ×”×•×¨××•×ª ×©×™××•×©</h3>
            <p>×œ×—×¥ ×¢×œ ×›×œ ×ª× ×œ×‘×—×™×¨×ª ××§×•× ×”×¢×‘×•×“×”. ×œ×—×¥ ×©×•×‘ ×›×“×™ ×œ×”×¡×™×¨ ×”×§×¦××”. ×”×©×ª××© ×‘×›×¤×ª×•×¨×™× ×œ× ×™×”×•×œ ×¢×•×‘×“×™× ×•××§×•××•×ª.</p>
        </div>
    </div>

    <!-- Modals (same as before) -->
    <div class="modal" id="placeSelectorModal">
        <div class="modal-content">
            <h3>×‘×—×¨ ××§×•× ×¢×‘×•×“×”</h3>
            <div class="place-choice" id="placeChoiceContainer"></div>
            <button class="btn-secondary" onclick="closePlaceSelector()">×‘×™×˜×•×œ</button>
        </div>
    </div>

    <div class="modal" id="addPlaceModal">
        <div class="modal-content">
            <h3>×”×•×¡×£ ××§×•× ×—×“×©</h3>
            <input id="newPlaceInput" placeholder="×©× ×”××§×•×" type="text"/>
            <div style="margin-top: 1rem; text-align: center;">
                <button onclick="saveNewPlace()">×©××•×¨</button>
                <button class="btn-secondary" onclick="closeAddPlaceModal()">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addWorkerModal">
        <div class="modal-content">
            <h3>×”×•×¡×£ ×¢×•×‘×“ ×—×“×©</h3>
            <input id="newWorkerInput" placeholder="×©× ×”×¢×•×‘×“" type="text"/>
            <input id="newWorkerId" placeholder="××¡×¤×¨ ×–×”×•×ª (××•×¤×¦×™×•× ×œ×™)" type="text"/>
            <label class="optional-label">×©×“×” ××•×¤×¦×™×•× ×œ×™</label>
            <input id="newWorkerPhone" placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ (××•×¤×¦×™×•× ×œ×™)" type="text"/>
            <label class="optional-label">×©×“×” ××•×¤×¦×™×•× ×œ×™</label>
            <div style="margin-top: 1rem; text-align: center;">
                <button onclick="saveNewWorker()">×©××•×¨</button>
                <button class="btn-secondary" onclick="closeAddWorkerModal()">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editWorkerModal">
        <div class="modal-content">
            <h3>×¢×¨×™×›×ª ×¤×¨×˜×™ ×¢×•×‘×“</h3>
            <input id="editWorkerName" placeholder="×©× ×”×¢×•×‘×“" type="text" />
            <input id="editWorkerId" placeholder="××¡×¤×¨ ×–×”×•×ª (××•×¤×¦×™×•× ×œ×™)" type="text" />
            <label class="optional-label">×©×“×” ××•×¤×¦×™×•× ×œ×™</label>
            <input id="editWorkerPhone" placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ (××•×¤×¦×™×•× ×œ×™)" type="text" />
            <label class="optional-label">×©×“×” ××•×¤×¦×™×•× ×œ×™</label>
            <div style="margin-top: 1rem; text-align: center;">
                <button onclick="saveEditedWorker()">×©××•×¨</button>
                <button class="btn-secondary" onclick="closeEditWorkerModal()">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="managePlacesModal">
        <div class="modal-content">
            <h3>× ×™×”×•×œ ××§×•××•×ª</h3>
            <div id="placeListContainer" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn-secondary" onclick="closeManagePlacesModal()">×¡×’×•×¨</button>
        </div>
    </div>

    <div class="modal" id="manageWorkersModal">
        <div class="modal-content">
            <h3>× ×™×”×•×œ ×¢×•×‘×“×™×</h3>
            <div id="workerListContainer" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn-secondary" onclick="closeManageWorkersModal()">×¡×’×•×¨</button>
        </div>
    </div>

    <div class="modal" id="workerDetailsModal">
        <div class="modal-content">
            <h3>×¤×¨×˜×™ ×¢×•×‘×“</h3>
            <p id="workerDetailsText"></p>
            <button class="btn-secondary" onclick="closeWorkerDetailsModal()">×¡×’×•×¨</button>
        </div>
    </div>

    <script>
        // Global variables
        const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
        const workers = [];
        const places = [];

        // Function to preserve current assignments before regenerating calendar
        function preserveAssignments() {
            const assignments = [];
            const rows = document.querySelectorAll('#calendarTable tbody tr, #calendarTable tr:not(:first-child)');
            
            rows.forEach((row, workerIndex) => {
                const cells = row.querySelectorAll('.time-cell');
                cells.forEach((cell, dayIndex) => {
                    if (cell.textContent.trim()) {
                        assignments.push({
                            workerIndex: workerIndex,
                            dayIndex: dayIndex,
                            value: cell.textContent.trim(),
                            assigned: cell.classList.contains('assigned')
                        });
                    }
                });
            });
            
            return assignments;
        }

        // Function to restore assignments after regenerating calendar
        function restoreAssignments(assignments) {
            const rows = document.querySelectorAll('#calendarTable tbody tr, #calendarTable tr:not(:first-child)');
            
            assignments.forEach(assignment => {
                if (rows[assignment.workerIndex]) {
                    const cells = rows[assignment.workerIndex].querySelectorAll('.time-cell');
                    if (cells[assignment.dayIndex]) {
                        cells[assignment.dayIndex].textContent = assignment.value;
                        if (assignment.assigned) {
                            cells[assignment.dayIndex].classList.add('assigned');
                        }
                    }
                }
            });
        }

        // Calendar generation using table structure
        function generateCalendar(preserveData = false) {
            // Preserve current assignments if requested
            let currentAssignments = [];
            if (preserveData) {
                currentAssignments = preserveAssignments();
            }
            
            const table = document.getElementById("calendarTable");
            table.innerHTML = '';
            
            // Create header row
            const headerRow = document.createElement('tr');
            
            // Add corner cell
            const cornerTh = document.createElement('th');
            cornerTh.textContent = '×¢×•×‘×“×™× / ×™××™×';
            cornerTh.className = 'corner-cell';
            headerRow.appendChild(cornerTh);
            
            // Add day headers
            days.forEach(day => {
                const dayTh = document.createElement('th');
                dayTh.textContent = day;
                headerRow.appendChild(dayTh);
            });
            
            table.appendChild(headerRow);

            // Add worker rows
            workers.forEach(worker => {
                const row = document.createElement('tr');
                
                // Worker name cell
                const nameCell = document.createElement('td');
                nameCell.className = 'name-cell';
                const name = typeof worker === 'string' ? worker : worker.name;
                nameCell.textContent = name;
                nameCell.onclick = () => showWorkerDetails(worker);
                row.appendChild(nameCell);
                
                // Add time cells for each day
                days.forEach(() => {
                    const cell = document.createElement('td');
                    cell.className = 'time-cell';
                    cell.onclick = () => {
                        if (cell.textContent.trim()) {
                            clearAssignment(cell);
                        } else {
                            openPlaceSelector(cell);
                        }
                    };
                    row.appendChild(cell);
                });
                
                table.appendChild(row);
            });
            
            // Restore assignments if we were preserving data
            if (preserveData && currentAssignments.length > 0) {
                restoreAssignments(currentAssignments);
            }
        }

        // Place selector functions
        function openPlaceSelector(cell) {
            const container = document.getElementById("placeChoiceContainer");
            container.innerHTML = '';
            
            places.forEach((place) => {
                const btn = document.createElement('button');
                btn.className = 'place-btn';
                btn.textContent = place;
                btn.onclick = () => {
                    cell.textContent = place;
                    cell.classList.add('assigned');
                    closePlaceSelector();
                    autoSaveSchedule();
                    updateAssignmentSummary();
                };
                container.appendChild(btn);
            });
            
            document.getElementById("placeSelectorModal").style.display = 'flex';
        }

        function closePlaceSelector() {
            document.getElementById("placeSelectorModal").style.display = 'none';
        }

        function clearAssignment(cell) {
            cell.textContent = '';
            cell.classList.remove('assigned');
            updateAssignmentSummary();
            autoSaveSchedule();
        }

        // Worker management functions
        function showAddWorkerModal() {
            document.getElementById("addWorkerModal").style.display = "flex";
        }

        function closeAddWorkerModal() {
            document.getElementById("addWorkerModal").style.display = "none";
            document.getElementById("newWorkerInput").value = '';
            document.getElementById("newWorkerId").value = '';
            document.getElementById("newWorkerPhone").value = '';
        }

        function saveNewWorker() {
            const nameInput = document.getElementById("newWorkerInput");
            const idInput = document.getElementById("newWorkerId");
            const phoneInput = document.getElementById("newWorkerPhone");
            
            const name = nameInput.value.trim();
            const id = idInput.value.trim();
            const phone = phoneInput.value.trim();
            
            if (name) {
                workers.push({ 
                    name, 
                    id: id || '', 
                    phone: phone || '' 
                });
                closeAddWorkerModal();
                // Use preserveData=true to keep current assignments
                generateCalendar(true);
                autoSaveSchedule();
            } else {
                alert("× × ×œ××œ× ××ª ×©× ×”×¢×•×‘×“.");
            }
        }

        function showManageWorkersModal() {
            const container = document.getElementById("workerListContainer");
            container.innerHTML = '';
            
            workers.forEach((worker, index) => {
                const row = document.createElement('div');
                row.className = 'worker-row';
                
                const details = document.createElement('span');
                let workerInfo = `<strong>${worker.name}</strong>`;
                if (worker.id) workerInfo += `<br>×–×”×•×ª: ${worker.id}`;
                if (worker.phone) workerInfo += `<br>ğŸ“ ${worker.phone}`;
                details.innerHTML = workerInfo;
                
                const buttons = document.createElement('div');
                buttons.innerHTML = `
                    <button onclick="editWorker(${index})" style="margin: 2px; padding: 4px 8px;">âœï¸</button>
                    <button class="btn-secondary" onclick="removeWorker(${index})" style="margin: 2px; padding: 4px 8px;">ğŸ—‘ï¸</button>
                `;

                row.appendChild(details);
                row.appendChild(buttons);
                container.appendChild(row);
            });

            document.getElementById("manageWorkersModal").style.display = 'flex';
        }

        function closeManageWorkersModal() {
            document.getElementById("manageWorkersModal").style.display = "none";
        }

        function removeWorker(index) {
            if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×ª×¨×¦×” ×œ××—×•×§ ××ª ×”×¢×•×‘×“ ×”×–×”?")) {
                workers.splice(index, 1);
                autoSaveSchedule();
                showManageWorkersModal();
                // Use preserveData=true but it won't preserve assignments for removed workers
                generateCalendar(false); // Actually, we should regenerate without preserving since worker was removed
            }
        }

        let editingWorkerIndex = null;

        function editWorker(index) {
            const worker = workers[index];
            document.getElementById("editWorkerName").value = worker.name;
            document.getElementById("editWorkerId").value = worker.id || '';
            document.getElementById("editWorkerPhone").value = worker.phone || '';
            editingWorkerIndex = index;
            closeManageWorkersModal();
            document.getElementById("editWorkerModal").style.display = "flex";
        }

        function saveEditedWorker() {
            const name = document.getElementById("editWorkerName").value.trim();
            const id = document.getElementById("editWorkerId").value.trim();
            const phone = document.getElementById("editWorkerPhone").value.trim();

            if (name) {
                workers[editingWorkerIndex] = { 
                    name, 
                    id: id || '', 
                    phone: phone || '' 
                };
                autoSaveSchedule();
                // Use preserveData=true to keep current assignments
                generateCalendar(true);
                closeEditWorkerModal();
            } else {
                alert("× × ×œ××œ× ××ª ×©× ×”×¢×•×‘×“.");
            }
        }

        function closeEditWorkerModal() {
            document.getElementById("editWorkerModal").style.display = "none";
            editingWorkerIndex = null;
        }

        function showWorkerDetails(worker) {
            let text;
            if (typeof worker === 'string') {
                text = `<strong>×©×:</strong> ${worker}<br><em>××™×Ÿ ××™×“×¢ × ×•×¡×£</em>`;
            } else {
                text = `<strong>×©×:</strong> ${worker.name}`;
                if (worker.id) text += `<br><strong>×–×”×•×ª:</strong> ${worker.id}`;
                if (worker.phone) text += `<br><strong>×˜×œ×¤×•×Ÿ:</strong> ${worker.phone}`;
                if (!worker.id && !worker.phone) text += `<br><em>××™×Ÿ ××™×“×¢ × ×•×¡×£</em>`;
            }
            document.getElementById("workerDetailsText").innerHTML = text;
            document.getElementById("workerDetailsModal").style.display = "flex";
        }

        function closeWorkerDetailsModal() {
            document.getElementById("workerDetailsModal").style.display = "none";
        }

        // Place management functions
        function showAddPlaceModal() {
            document.getElementById("addPlaceModal").style.display = "flex";
        }

        function closeAddPlaceModal() {
            document.getElementById("addPlaceModal").style.display = "none";
            document.getElementById("newPlaceInput").value = '';
        }

        function saveNewPlace() {
            const input = document.getElementById("newPlaceInput");
            const name = input.value.trim();
            if (name) {
                places.push(name);
                closeAddPlaceModal();
                autoSaveSchedule();
            } else {
                alert("× × ×œ×”×–×™×Ÿ ×©× ××§×•×.");
            }
        }

        function showManagePlacesModal() {
            const container = document.getElementById("placeListContainer");
            container.innerHTML = '';
            
            places.forEach((place, index) => {
                const row = document.createElement('div');
                row.className = 'place-row';
                row.innerHTML = `
                    <span>${place}</span>
                    <div>
                        <button onclick="renamePlace(${index})" style="margin: 2px; padding: 4px 8px;">âœï¸</button>
                        <button class="btn-secondary" onclick="removePlace(${index})" style="margin: 2px; padding: 4px 8px;">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(row);
            });
            
            document.getElementById("managePlacesModal").style.display = 'flex';
        }

        function closeManagePlacesModal() {
            document.getElementById("managePlacesModal").style.display = "none";
        }

        function renamePlace(index) {
            const newName = prompt("×”×–×Ÿ ×©× ×—×“×© ×œ××§×•×:", places[index]);
            if (newName) {
                const oldName = places[index];
                places[index] = newName.trim();
                
                // Update all assignments with the old name
                document.querySelectorAll('.time-cell').forEach(cell => {
                    if (cell.textContent.trim() === oldName) {
                        cell.textContent = newName.trim();
                    }
                });
                
                showManagePlacesModal();
                autoSaveSchedule();
                updateAssignmentSummary();
            }
        }

        function removePlace(index) {
            if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×ª×¨×¦×” ×œ××—×•×§ ××ª ×”××§×•× ×”×–×”?")) {
                const placeName = places[index];
                places.splice(index, 1);
                
                // Clear all assignments for this place
                document.querySelectorAll('.time-cell').forEach(cell => {
                    if (cell.textContent.trim() === placeName) {
                        clearAssignment(cell);
                    }
                });
                
                showManagePlacesModal();
                autoSaveSchedule();
                updateAssignmentSummary();
            }
        }

        // Summary and save functions
        function updateAssignmentSummary() {
            const workerDays = {};
            let totalDays = 0;

            // Initialize counters for all workers
            workers.forEach(worker => {
                const name = typeof worker === 'string' ? worker : worker.name;
                workerDays[name] = 0;
            });

            // Count days for each worker
            const rows = document.querySelectorAll('#calendarTable tbody tr, #calendarTable tr:not(:first-child)');
            rows.forEach((row, workerIndex) => {
                if (workers[workerIndex]) {
                    const workerName = typeof workers[workerIndex] === 'string' ? workers[workerIndex] : workers[workerIndex].name;
                    const cells = row.querySelectorAll('.time-cell');
                    cells.forEach(cell => {
                        if (cell.textContent.trim()) {
                            workerDays[workerName]++;
                            totalDays++;
                        }
                    });
                }
            });

            let summary = `×¡×”"×› ×™××™ ×¢×‘×•×“×”: ${totalDays}<br><br>`;
            summary += '<strong>×™××™ ×¢×‘×•×“×” ×œ×›×œ ×¢×•×‘×“:</strong><br>';
            
            for (const [workerName, days] of Object.entries(workerDays)) {
                summary += `${workerName}: ${days} ×™××™×<br>`;
            }

            document.getElementById('assignmentSummary').innerHTML = summary;
        }

        function autoSaveSchedule() {
            const data = {
                workers,
                places,
                assignments: []
            };
            
            const cells = document.querySelectorAll('.time-cell');
            cells.forEach((cell, index) => {
                if (cell.textContent.trim()) {
                    data.assignments.push({ 
                        index, 
                        value: cell.textContent.trim()
                    });
                }
            });
            
            localStorage.setItem("scheduleData", JSON.stringify(data));
            updateAssignmentSummary();
        }

        function loadSchedule(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    workers.length = 0;
                    places.length = 0;
                    workers.push(...data.workers);
                    places.push(...data.places);
                    generateCalendar();
                    
                    const cells = document.querySelectorAll('.time-cell');
                    data.assignments.forEach(a => {
                        if (cells[a.index]) {
                            cells[a.index].textContent = a.value;
                            cells[a.index].classList.add('assigned');
                        }
                    });
                    
                    updateAssignmentSummary();
                    autoSaveSchedule();
                    alert("×”×§×•×‘×¥ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!");
                } catch (error) {
                    alert("×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥!");
                }
            };
            reader.readAsText(file);
        }

        function saveSchedule() {
            const fileName = prompt("×”×–×Ÿ ×©× ×§×•×‘×¥ ×œ×©××™×¨×”:", "×œ×•×—_××©××¨×•×ª.json");
            if (!fileName) return;

            const data = {
                workers,
                places,
                assignments: []
            };
            
            const cells = document.querySelectorAll('.time-cell');
            cells.forEach((cell, index) => {
                if (cell.textContent.trim()) {
                    data.assignments.push({ 
                        index, 
                        value: cell.textContent.trim()
                    });
                }
            });
            
            const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName.endsWith(".json") ? fileName : fileName + ".json";
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAssignments() {
            document.querySelectorAll('.time-cell').forEach(cell => {
                clearAssignment(cell);
            });
            updateAssignmentSummary();
        }

        function resetLocalStorage() {
            if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×ª×¨×¦×” ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×?")) {
                localStorage.removeItem("scheduleData");
                location.reload();
            }
        }

        // Enhanced print function
        function printSchedule() {
            // Add print title
            const printTitle = document.createElement('div');
            printTitle.innerHTML = '<h2 style="text-align:center; margin-bottom:20px; font-size:18px; color:black;">×œ×•×— ××©××¨×•×ª - ' + new Date().toLocaleDateString('he-IL') + '</h2>';
            printTitle.style.display = 'none';
            printTitle.className = 'print-title';
            document.body.appendChild(printTitle);

            // Add print styles for title
            const printStyle = document.createElement('style');
            printStyle.innerHTML = `
                @media print {
                    .print-title {
                        display: block !important;
                        page-break-after: avoid !important;
                        margin-bottom: 15px !important;
                    }
                }
            `;
            document.head.appendChild(printStyle);

            window.print();

            // Cleanup
            document.body.removeChild(printTitle);
            document.head.removeChild(printStyle);
        }

        // Export to Excel function
        function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                // Prepare data for the main schedule sheet
                const scheduleData = [];
                const headerRow = ['×¢×•×‘×“'];
                days.forEach(day => headerRow.push(day));
                scheduleData.push(headerRow);
                
                // Add worker rows
                const cells = document.querySelectorAll('.time-cell');
                let cellIndex = 0;
                
                workers.forEach(worker => {
                    const row = [typeof worker === 'string' ? worker : worker.name];
                    
                    days.forEach(() => {
                        const cellValue = cells[cellIndex] ? cells[cellIndex].textContent.trim() : '';
                        row.push(cellValue);
                        cellIndex++;
                    });
                    
                    scheduleData.push(row);
                });
                
                // Create worksheet for schedule
                const ws1 = XLSX.utils.aoa_to_sheet(scheduleData);
                const colWidths = [{ wch: 20 }];
                days.forEach(() => colWidths.push({ wch: 15 }));
                ws1['!cols'] = colWidths;
                XLSX.utils.book_append_sheet(wb, ws1, '×œ×•×— ××©××¨×•×ª');
                
                // Create summary sheet
                const summaryData = [['××§×•×', '××¡×¤×¨ ×¢×•×‘×“×™×']];
                const counters = {};
                places.forEach(place => counters[place] = 0);
                
                document.querySelectorAll('.time-cell').forEach(cell => {
                    const place = cell.textContent.trim();
                    if (place && counters.hasOwnProperty(place)) {
                        counters[place]++;
                    }
                });
                
                let total = 0;
                for (const [place, count] of Object.entries(counters)) {
                    summaryData.push([place, count]);
                    total += count;
                }
                summaryData.push(['×¡×”"×›', total]);
                
                const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
                ws2['!cols'] = [{ wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws2, '×¡×™×›×•×');
                
                // Create workers details sheet
                const workersData = [['×©×', '××¡×¤×¨ ×–×”×•×ª', '××¡×¤×¨ ×˜×œ×¤×•×Ÿ']];
                workers.forEach(worker => {
                    if (typeof worker === 'string') {
                        workersData.push([worker, '', '']);
                    } else {
                        workersData.push([worker.name, worker.id || '', worker.phone || '']);
                    }
                });
                
                const ws3 = XLSX.utils.aoa_to_sheet(workersData);
                ws3['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws3, '×¤×¨×˜×™ ×¢×•×‘×“×™×');
                
                // Generate filename with current date
                const now = new Date();
                const dateStr = now.toLocaleDateString('he-IL').replace(/\//g, '-');
                const filename = `×œ×•×—_××©××¨×•×ª_${dateStr}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                alert('âœ… ×”×§×•×‘×¥ ×™×•×¦× ×‘×”×¦×œ×—×”!');
                
            } catch (error) {
                console.error('Export error:', error);
                alert('âŒ ××™×¨×¢×” ×©×’×™××” ×‘×–××Ÿ ×™×¦×•× ×”×§×•×‘×¥');
            }
        }

        // Initialize on page load
        window.onload = () => {
            const saved = localStorage.getItem("scheduleData");
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    workers.push(...(data.workers || []));
                    places.push(...(data.places || []));
                    generateCalendar();
                    
                    const cells = document.querySelectorAll('.time-cell');
                    if (data.assignments) {
                        data.assignments.forEach(a => {
                            if (cells[a.index]) {
                                cells[a.index].textContent = a.value;
                                cells[a.index].classList.add('assigned');
                            }
                        });
                    }
                    
                    updateAssignmentSummary();
                } catch (error) {
                    console.error('Error loading saved data:', error);
                    generateCalendar();
                }
            } else {
                generateCalendar();
            }
        };
    </script>
</body>
</html>

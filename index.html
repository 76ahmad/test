<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>מערכת ניהול משמרות</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📅 מערכת ניהול משמרות</h1>
      <p>ניהול משמרות עובדים ומקומות עבודה</p>
    </div>

    <div class="controls">
      <button onclick="saveSchedule()">💾 שמור קובץ</button>
      <input type="file" id="fileInput" accept=".json" onchange="loadSchedule(event)" style="display:none"/>
      <button onclick="document.getElementById('fileInput').click()">📂 טען קובץ</button>
      <button onclick="showAddPlaceModal()">➕ הוסף מקום</button>
      <button onclick="showAddWorkerModal()">👤 הוסף עובד</button>
      <button onclick="showManagePlacesModal()">⚙️ ניהול מקומות</button>
      <button onclick="showManageWorkersModal()">👥 ניהול עובדים</button>
      <button class="btn-success" onclick="printSchedule()">🖨️ הדפסה</button>
      <button class="btn-info" onclick="exportToExcel()">📊 יצא ל-Excel</button>
      <button class="btn-secondary" onclick="clearAssignments()">🗑️ נקה הקצאות</button>
      <button class="btn-secondary" onclick="resetLocalStorage()">🔄 אפס נתונים</button>
    </div>

    <div class="calendar-container">
      <div class="calendar-grid" id="calendar"></div>
    </div>

    <div id="assignmentSummary"></div>

    <div class="instructions">
      <h3>📌 הוראות שימוש</h3>
      <p>לחץ על תא כדי לבחור מקום עבודה. לחץ שוב כדי להסיר הקצאה. השתמש בכפתורים כדי להוסיף/לנהל עובדים ומקומות.</p>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let workers = [];
    let places = [];
    let assignments = {};
    const days = ["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];

    function saveSchedule() {
      const data = { workers, places, assignments };
      const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "schedule.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function loadSchedule(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const data = JSON.parse(e.target.result);
        workers = data.workers || [];
        places = data.places || [];
        assignments = data.assignments || {};
        renderCalendar();
      };
      reader.readAsText(file);
    }

    function printSchedule() {
      window.print();
    }

    function exportToExcel() {
      const ws_data = [["עובד", ...days]];
      workers.forEach(w => {
        const row = [w.name];
        days.forEach((d, di) => {
          let assigned = "";
          for (let key in assignments) {
            if (assignments[key] === di) {
              const [wid, day] = key.split("-");
              if (wid == workers.indexOf(w)) assigned = places[assignments[key]];
            }
          }
          row.push(assigned);
        });
        ws_data.push(row);
      });
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "לו\"ז");
      XLSX.writeFile(wb, "schedule.xlsx");
    }

    function clearAssignments() {
      assignments = {};
      renderCalendar();
    }

    function resetLocalStorage() {
      workers = [];
      places = [];
      assignments = {};
      renderCalendar();
    }

    function renderCalendar() {
      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";
      const cols = days.length + 1;
      calendar.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

      // Header row
      const headerRow = document.createElement("div");
      headerRow.className = "header-cell";
      headerRow.textContent = "עובד";
      calendar.appendChild(headerRow);
      days.forEach(d => {
        const cell = document.createElement("div");
        cell.className = "header-cell";
        cell.textContent = d;
        calendar.appendChild(cell);
      });

      // Workers rows
      workers.forEach((w, wi) => {
        const nameCell = document.createElement("div");
        nameCell.className = "name-cell";
        nameCell.textContent = w.name;
        calendar.appendChild(nameCell);

        days.forEach((d, di) => {
          const cell = document.createElement("div");
          cell.className = "time-cell";
          const key = `${wi}-${di}`;
          if (assignments[key] !== undefined) {
            cell.classList.add("assigned");
            cell.textContent = places[assignments[key]];
          }
          cell.onclick = () => {
            if (assignments[key] !== undefined) {
              delete assignments[key];
              cell.classList.remove("assigned");
              cell.textContent = "";
            } else {
              const choice = prompt("בחר מקום עבודה: " + places.join(", "));
              if (choice && places.includes(choice)) {
                assignments[key] = places.indexOf(choice);
                cell.classList.add("assigned");
                cell.textContent = choice;
              }
            }
          };
          calendar.appendChild(cell);
        });
      });
    }

    function showAddWorkerModal() {
      const name = prompt("שם העובד (חובה):");
      if (!name) return;
      const id = prompt("תעודת זהות (לא חובה):") || "";
      const phone = prompt("טלפון (לא חובה):") || "";
      workers.push({ name, id, phone });
      renderCalendar();
    }

    function showAddPlaceModal() {
      const place = prompt("שם מקום העבודה:");
      if (place) {
        places.push(place);
        renderCalendar();
      }
    }

    function showManageWorkersModal() {
      alert("ניהול עובדים יתוסף כאן (ניתן לערוך/למחוק עובדים)");
    }

    function showManagePlacesModal() {
      alert("ניהול מקומות יתוסף כאן (ניתן לערוך/למחוק מקומות)");
    }

    window.onload = renderCalendar;
  </script>
</body>
</html>

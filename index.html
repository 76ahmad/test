<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>××¢×¨×›×ª ×”×§×¦××ª ×¢×•×‘×“×™×</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2rem;
        }
        
        .header p {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .controls, .instructions {
            padding: 1rem 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        
        .calendar-container {
            overflow-x: auto;
            margin: 2rem;
        }
        
        .calendar-grid {
            display: grid;
            min-width: 800px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .calendar-grid .header-cell, 
        .calendar-grid .name-cell, 
        .calendar-grid .time-cell {
            padding: 1rem;
            border: 1px solid #ccc;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: background 0.2s;
        }
        
        .calendar-grid .time-cell:hover {
            background: #d6f0ff;
        }
        
        .calendar-grid .time-cell.assigned {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #2d2d2d;
            color: white;
            padding: 2rem;
            border-radius: 10px;
            width: 300px;
            max-width: 90%;
        }
        
        .modal-content h3 {
            margin-top: 0;
            text-align: center;
        }
        
        .place-choice {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .place-btn {
            border: 2px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: #ffffff;
            cursor: pointer;
            font-weight: bold;
            color: #333;
        }
        
        .place-btn:hover {
            border-color: #0056b3;
            background: #e2e6ea;
        }
        
        button {
            margin: 0.25rem;
            padding: 0.6rem 1.4rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s, transform 0.1s;
            background: #007bff;
            color: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }
        
        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .header-cell {
            background: #343a40 !important;
            color: #fff !important;
            font-weight: bold;
        }
        
        .name-cell {
            background: #212529 !important;
            color: #fff !important;
            font-weight: bold;
        }
        
        .place-color-0 { background-color: #d1ecf1 !important; border-color: #0c5460 !important; }
        .place-color-1 { background-color: #d4edda !important; border-color: #155724 !important; }
        .place-color-2 { background-color: #fff3cd !important; border-color: #856404 !important; }
        .place-color-3 { background-color: #f8d7da !important; border-color: #721c24 !important; }
        .place-color-4 { background-color: #e2e3e5 !important; border-color: #6c757d !important; }
        .place-color-5 { background-color: #cfe2ff !important; border-color: #084298 !important; }
        .place-color-6 { background-color: #e8daef !important; border-color: #512e5f !important; }
        
        #assignmentSummary {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            padding: 1rem;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 8px;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.8);
            margin: 2rem;
            border-radius: 12px;
        }
        
        .instructions h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .instructions p {
            color: #666;
            line-height: 1.5;
        }
        
        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .worker-row, .place-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            padding: 0.5rem;
            border-radius: 6px;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .worker-row span, .place-row span {
            font-weight: bold;
        }
        
        /* Print styles */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
            }
            
            .container {
                box-shadow: none !important;
                background: white !important;
                border-radius: 0 !important;
            }
            
            .controls, .instructions {
                display: none !important;
            }
            
            .header {
                background: #333 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .calendar-grid {
                background: white !important;
            }
            
            .header-cell, .name-cell {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .time-cell.assigned {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            #assignmentSummary {
                display: none !important;
            }
        }
    </style>

    <!-- SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase Auth Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            authDomain: "farkad-scheduler.firebaseapp.com",
            projectId: "farkad-scheduler",
            storageBucket: "farkad-scheduler.firebasestorage.app",
            messagingSenderId: "71149615141",
            appId: "1:71149615141:web:97eac63fe0c39d4831a7cc",
            measurementId: "G-41H0PK4LMR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        // Auth check on page load
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
                window.location.href = "login.html";
                return;
            }

            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists() || !userDoc.data().paid) {
                alert("Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙØ¹Ù„. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.");
                window.location.href = "login.html";
            } else {
                console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆÙ…Ø¹ØªÙ…Ø¯");
            }
        });

        // Save schedule to Firestore
        window.saveScheduleToFirebase = async function(data) {
            const user = auth.currentUser;
            if (!user) return;
            const userDoc = doc(db, "schedules", user.uid);
            await setDoc(userDoc, data);
            alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­");
        };
    </script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª</h1>
            <p>Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†Ø§ÙˆØ¨Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„ ÙˆØ£Ù…Ø§ÙƒÙ† Ø§Ù„Ø¹Ù…Ù„</p>
        </div>
        
        <div class="controls">
            <button onclick="saveSchedule()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù</button>
            <input accept=".json" id="fileInput" onchange="loadSchedule(event)" style="display:none" type="file"/>
            <button onclick="document.getElementById('fileInput').click()">ğŸ“‚ ØªØ­Ù…ÙŠÙ„</button>
            <button onclick="showAddPlaceModal()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØ§Ù†</button>
            <button onclick="showAddWorkerModal()">ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„</button>
            <button onclick="showManagePlacesModal()">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</button>
            <button onclick="showManageWorkersModal()">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ø§Ù„</button>
            <button class="btn-success" onclick="printSchedule()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
            <button class="btn-info" onclick="exportToExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
            <button class="btn-secondary" onclick="clearAssignments()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</button>
            <button class="btn-secondary" onclick="resetLocalStorage()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>

        <div class="calendar-container">
            <div class="calendar-grid" id="calendar"></div>
        </div>
        
        <div id="assignmentSummary"></div>

        <div class="instructions">
            <h3>ğŸ“Œ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h3>
            <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø®Ø§Ù†Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„. Ø§Ø¶ØºØ· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ø£Ù…Ø§ÙƒÙ†.</p>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="placeSelectorModal">
        <div class="modal-content">
            <h3>Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</h3>
            <div class="place-choice" id="placeChoiceContainer"></div>
            <button class="btn-secondary" onclick="closePlaceSelector()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="modal" id="addPlaceModal">
        <div class="modal-content">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯</h3>
            <input id="newPlaceInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†" type="text"/>
            <div style="margin-top: 1rem; text-align: center;">
                <button onclick="saveNewPlace()">Ø­ÙØ¸</button>
                <button class="btn-secondary" onclick="closeAddPlaceModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addWorkerModal">
        <div class="modal-content">
            <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯</h3>
            <input id="newWorkerInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„" type="text"/>
            <input id="newWorkerId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©" type="text"/>
            <input id="newWorkerPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" type="text"/>
            <div style="margin-top: 1rem; text-align: center;">
                <button onclick="saveNewWorker()">Ø­ÙØ¸</button>
                <button class="btn-secondary" onclick="closeAddWorkerModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editWorkerModal">
        <div class="modal-content">
            <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ù„</h3>
            <input id="editWorkerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„" type="text" />
            <input id="editWorkerId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©" type="text" />
            <input id="editWorkerPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" type="text" />
            <div style="margin-top: 1rem; text-align: center;">
                <button onclick="saveEditedWorker()">Ø­ÙØ¸</button>
                <button class="btn-secondary" onclick="closeEditWorkerModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div class="modal" id="managePlacesModal">
        <div class="modal-content">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</h3>
            <div id="placeListContainer" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn-secondary" onclick="closeManagePlacesModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="modal" id="manageWorkersModal">
        <div class="modal-content">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ø§Ù„</h3>
            <div id="workerListContainer" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn-secondary" onclick="closeManageWorkersModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="modal" id="workerDetailsModal">
        <div class="modal-content">
            <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…Ù„</h3>
            <p id="workerDetailsText"></p>
            <button class="btn-secondary" onclick="closeWorkerDetailsModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // Global variables
        const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
        const workers = [];
        const places = [];

        // Calendar generation
        function generateCalendar() {
            const calendar = document.getElementById("calendar");
            calendar.innerHTML = '';
            calendar.style.gridTemplateColumns = `repeat(${days.length + 1}, 1fr)`;

            // Add empty header cell
            calendar.appendChild(createCell('', 'header-cell'));
            
            // Add day headers
            days.forEach(day => calendar.appendChild(createCell(day, 'header-cell')));

            // Add worker rows
            workers.forEach(worker => {
                const name = typeof worker === 'string' ? worker : worker.name;
                const nameCell = createCell(name, 'name-cell');
                nameCell.onclick = () => showWorkerDetails(worker);
                calendar.appendChild(nameCell);
                
                // Add time cells for each day
                days.forEach(() => {
                    const cell = createCell('', 'time-cell');
                    cell.onclick = () => {
                        if (cell.textContent.trim()) {
                            clearAssignment(cell);
                        } else {
                            openPlaceSelector(cell);
                        }
                    };
                    calendar.appendChild(cell);
                });
            });
        }

        function createCell(text, className) {
            const div = document.createElement('div');
            div.className = className;
            div.textContent = text;
            return div;
        }

        // Place selector functions
        function openPlaceSelector(cell) {
            const container = document.getElementById("placeChoiceContainer");
            container.innerHTML = '';
            
            places.forEach((place, index) => {
                const btn = document.createElement('button');
                btn.className = 'place-btn';
                btn.textContent = place;
                btn.onclick = () => {
                    cell.textContent = place;
                    cell.className = 'time-cell assigned place-color-' + (index % 7);
                    closePlaceSelector();
                    autoSaveSchedule();
                    updateAssignmentSummary();
                };
                container.appendChild(btn);
            });
            
            document.getElementById("placeSelectorModal").style.display = 'flex';
        }

        function closePlaceSelector() {
            document.getElementById("placeSelectorModal").style.display = 'none';
        }

        function clearAssignment(cell) {
            cell.textContent = '';
            cell.classList.remove('assigned');
            // Remove all place-color classes
            for (let i = 0; i < 7; i++) {
                cell.classList.remove('place-color-' + i);
            }
            updateAssignmentSummary();
            autoSaveSchedule();
        }

        // Worker management functions
        function showAddWorkerModal() {
            document.getElementById("addWorkerModal").style.display = "flex";
        }

        function closeAddWorkerModal() {
            document.getElementById("addWorkerModal").style.display = "none";
            document.getElementById("newWorkerInput").value = '';
            document.getElementById("newWorkerId").value = '';
            document.getElementById("newWorkerPhone").value = '';
        }

        function saveNewWorker() {
            const nameInput = document.getElementById("newWorkerInput");
            const idInput = document.getElementById("newWorkerId");
            const phoneInput = document.getElementById("newWorkerPhone");
            
            const name = nameInput.value.trim();
            const id = idInput.value.trim();
            const phone = phoneInput.value.trim();
            
            if (name && id && phone) {
                workers.push({ name, id, phone });
                closeAddWorkerModal();
                generateCalendar();
                autoSaveSchedule();
            } else {
                alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.");
            }
        }

        function showManageWorkersModal() {
            const container = document.getElementById("workerListContainer");
            container.innerHTML = '';
            
            workers.forEach((worker, index) => {
                const row = document.createElement('div');
                row.className = 'worker-row';
                
                const details = document.createElement('span');
                details.innerHTML = `<strong>${worker.name}</strong><br>Ù‡ÙˆÙŠØ©: ${worker.id}<br>ğŸ“ ${worker.phone}`;
                
                const buttons = document.createElement('div');
                buttons.innerHTML = `
                    <button onclick="editWorker(${index})" style="margin: 2px; padding: 4px 8px;">âœï¸</button>
                    <button class="btn-secondary" onclick="removeWorker(${index})" style="margin: 2px; padding: 4px 8px;">ğŸ—‘ï¸</button>
                `;

                row.appendChild(details);
                row.appendChild(buttons);
                container.appendChild(row);
            });

            document.getElementById("manageWorkersModal").style.display = 'flex';
        }

        function closeManageWorkersModal() {
            document.getElementById("manageWorkersModal").style.display = "none";
        }

        function removeWorker(index) {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…Ù„ØŸ")) {
                workers.splice(index, 1);
                autoSaveSchedule();
                showManageWorkersModal();
                generateCalendar();
            }
        }

        let editingWorkerIndex = null;

        function editWorker(index) {
            const worker = workers[index];
            document.getElementById("editWorkerName").value = worker.name;
            document.getElementById("editWorkerId").value = worker.id;
            document.getElementById("editWorkerPhone").value = worker.phone;
            editingWorkerIndex = index;
            closeManageWorkersModal();
            document.getElementById("editWorkerModal").style.display = "flex";
        }

        function saveEditedWorker() {
            const name = document.getElementById("editWorkerName").value.trim();
            const id = document.getElementById("editWorkerId").value.trim();
            const phone = document.getElementById("editWorkerPhone").value.trim();

            if (name && id && phone) {
                workers[editingWorkerIndex] = { name, id, phone };
                autoSaveSchedule();
                generateCalendar();
                closeEditWorkerModal();
            } else {
                alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.");
            }
        }

        function closeEditWorkerModal() {
            document.getElementById("editWorkerModal").style.display = "none";
            editingWorkerIndex = null;
        }

        function showWorkerDetails(worker) {
            const text = typeof worker === 'string'
                ? `<strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${worker}<br><em>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</em>`
                : `<strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${worker.name}<br><strong>Ø§Ù„Ù‡ÙˆÙŠØ©:</strong> ${worker.id}<br><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${worker.phone}`;
            document.getElementById("workerDetailsText").innerHTML = text;
            document.getElementById("workerDetailsModal").style.display = "flex";
        }

        function closeWorkerDetailsModal() {
            document.getElementById("workerDetailsModal").style.display = "none";
        }

        // Place management functions
        function showAddPlaceModal() {
            document.getElementById("addPlaceModal").style.display = "flex";
        }

        function closeAddPlaceModal() {
            document.getElementById("addPlaceModal").style.display = "none";
            document.getElementById("newPlaceInput").value = '';
        }

        function saveNewPlace() {
            const input = document.getElementById("newPlaceInput");
            const name = input.value.trim();
            if (name) {
                places.push(name);
                closeAddPlaceModal();
                autoSaveSchedule();
            } else {
                alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†.");
            }
        }

        function showManagePlacesModal() {
            const container = document.getElementById("placeListContainer");
            container.innerHTML = '';
            
            places.forEach((place, index) => {
                const row = document.createElement('div');
                row.className = 'place-row';
                row.innerHTML = `
                    <span>${place}</span>
                    <div>
                        <button onclick="renamePlace(${index})" style="margin: 2px; padding: 4px 8px;">âœï¸</button>
                        <button class="btn-secondary" onclick="removePlace(${index})" style="margin: 2px; padding: 4px 8px;">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(row);
            });
            
            document.getElementById("managePlacesModal").style.display = 'flex';
        }

        function closeManagePlacesModal() {
            document.getElementById("managePlacesModal").style.display = "none";
        }

        function renamePlace(index) {
            const newName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…ÙƒØ§Ù†:", places[index]);
            if (newName) {
                const oldName = places[index];
                places[index] = newName.trim();
                
                // Update all assignments with the old name
                document.querySelectorAll('.time-cell').forEach(cell => {
                    if (cell.textContent.trim() === oldName) {
                        cell.textContent = newName.trim();
                    }
                });
                
                showManagePlacesModal();
                autoSaveSchedule();
                updateAssignmentSummary();
            }
        }

        function removePlace(index) {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙƒØ§Ù†ØŸ")) {
                const placeName = places[index];
                places.splice(index, 1);
                
                // Clear all assignments for this place
                document.querySelectorAll('.time-cell').forEach(cell => {
                    if (cell.textContent.trim() === placeName) {
                        clearAssignment(cell);
                    }
                });
                
                showManagePlacesModal();
                autoSaveSchedule();
                updateAssignmentSummary();
            }
        }

        // Summary and save functions
        function updateAssignmentSummary() {
            const counters = {};
            let total = 0;
            places.forEach(place => counters[place] = 0);

            document.querySelectorAll('.time-cell').forEach(cell => {
                const place = cell.textContent.trim();
                if (place && counters.hasOwnProperty(place)) {
                    counters[place]++;
                    total++;
                }
            });

            let summary = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª: ${total}<br>`;
            for (const [place, count] of Object.entries(counters)) {
                summary += `${place}: ${count} Ø¹Ø§Ù…Ù„<br>`;
            }

            document.getElementById('assignmentSummary').innerHTML = summary;
        }

        function autoSaveSchedule() {
            const data = {
                workers,
                places,
                assignments: []
            };
            
            const cells = document.querySelectorAll('.time-cell');
            cells.forEach((cell, index) => {
                if (cell.textContent.trim()) {
                    let colorClass = '';
                    for (let i = 0; i < 7; i++) {
                        if (cell.classList.contains('place-color-' + i)) {
                            colorClass = 'place-color-' + i;
                            break;
                        }
                    }
                    data.assignments.push({ 
                        index, 
                        value: cell.textContent.trim(),
                        colorClass: colorClass 
                    });
                }
            });
            
            const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName.endsWith(".json") ? fileName : fileName + ".json";
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAssignments() {
            document.querySelectorAll('.time-cell').forEach(cell => {
                clearAssignment(cell);
            });
            updateAssignmentSummary();
        }

        function resetLocalStorage() {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) {
                localStorage.removeItem("scheduleData");
                location.reload();
            }
        }

        // Print function
        function printSchedule() {
            const summary = document.getElementById('assignmentSummary');
            const originalDisplay = summary.style.display;
            summary.style.display = 'none';
            
            window.print();
            
            summary.style.display = originalDisplay;
        }

        // Export to Excel function
        function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                // Prepare data for the main schedule sheet
                const scheduleData = [];
                const headerRow = ['Ø§Ù„Ø¹Ø§Ù…Ù„'];
                days.forEach(day => headerRow.push(day));
                scheduleData.push(headerRow);
                
                // Add worker rows
                const cells = document.querySelectorAll('.time-cell');
                let cellIndex = 0;
                
                workers.forEach(worker => {
                    const row = [typeof worker === 'string' ? worker : worker.name];
                    
                    days.forEach(() => {
                        const cellValue = cells[cellIndex] ? cells[cellIndex].textContent.trim() : '';
                        row.push(cellValue);
                        cellIndex++;
                    });
                    
                    scheduleData.push(row);
                });
                
                // Create worksheet for schedule
                const ws1 = XLSX.utils.aoa_to_sheet(scheduleData);
                const colWidths = [{ wch: 20 }];
                days.forEach(() => colWidths.push({ wch: 15 }));
                ws1['!cols'] = colWidths;
                XLSX.utils.book_append_sheet(wb, ws1, 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª');
                
                // Create summary sheet
                const summaryData = [['Ø§Ù„Ù…ÙƒØ§Ù†', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ù„']];
                const counters = {};
                places.forEach(place => counters[place] = 0);
                
                document.querySelectorAll('.time-cell').forEach(cell => {
                    const place = cell.textContent.trim();
                    if (place && counters.hasOwnProperty(place)) {
                        counters[place]++;
                    }
                });
                
                let total = 0;
                for (const [place, count] of Object.entries(counters)) {
                    summaryData.push([place, count]);
                    total += count;
                }
                summaryData.push(['Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', total]);
                
                const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
                ws2['!cols'] = [{ wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws2, 'Ø§Ù„Ù…Ù„Ø®Øµ');
                
                // Create workers details sheet
                const workersData = [['Ø§Ù„Ø§Ø³Ù…', 'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ']];
                workers.forEach(worker => {
                    if (typeof worker === 'string') {
                        workersData.push([worker, '', '']);
                    } else {
                        workersData.push([worker.name, worker.id, worker.phone]);
                    }
                });
                
                const ws3 = XLSX.utils.aoa_to_sheet(workersData);
                ws3['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws3, 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„');
                
                // Generate filename with current date
                const now = new Date();
                const dateStr = now.toLocaleDateString('ar-EG').replace(/\//g, '-');
                const filename = `Ø¬Ø¯ÙˆÙ„_Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª_${dateStr}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!');
                
            } catch (error) {
                console.error('Export error:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù');
            }
        }

        // Initialize on page load
        window.onload = () => {
            const saved = localStorage.getItem("scheduleData");
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    workers.push(...(data.workers || []));
                    places.push(...(data.places || []));
                    generateCalendar();
                    
                    const cells = document.querySelectorAll('.time-cell');
                    if (data.assignments) {
                        data.assignments.forEach(a => {
                            if (cells[a.index]) {
                                cells[a.index].textContent = a.value;
                                cells[a.index].classList.add('assigned');
                                if (a.colorClass) {
                                    cells[a.index].classList.add(a.colorClass);
                                }
                            }
                        });
                    }
                    
                    updateAssignmentSummary();
                } catch (error) {
                    console.error('Error loading saved data:', error);
                    generateCalendar();
                }
            } else {
                generateCalendar();
            }
        };
    </script>
</body>
</html>trim()) {
                    let colorClass = '';
                    for (let i = 0; i < 7; i++) {
                        if (cell.classList.contains('place-color-' + i)) {
                            colorClass = 'place-color-' + i;
                            break;
                        }
                    }
                    data.assignments.push({ 
                        index, 
                        value: cell.textContent.trim(),
                        colorClass: colorClass 
                    });
                }
            });
            
            localStorage.setItem("scheduleData", JSON.stringify(data));
            if (typeof saveScheduleToFirebase === 'function') {
                saveScheduleToFirebase(data);
            }
            updateAssignmentSummary();
        }

        function loadSchedule(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    workers.length = 0;
                    places.length = 0;
                    workers.push(...data.workers);
                    places.push(...data.places);
                    generateCalendar();
                    
                    const cells = document.querySelectorAll('.time-cell');
                    data.assignments.forEach(a => {
                        if (cells[a.index]) {
                            cells[a.index].textContent = a.value;
                            cells[a.index].classList.add('assigned');
                            if (a.colorClass) {
                                cells[a.index].classList.add(a.colorClass);
                            }
                        }
                    });
                    
                    updateAssignmentSummary();
                    autoSaveSchedule();
                    alert("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!");
                } catch (error) {
                    alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù!");
                }
            };
            reader.readAsText(file);
        }

        function saveSchedule() {
            const fileName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø­ÙØ¸:", "Ø¬Ø¯ÙˆÙ„_Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª.json");
            if (!fileName) return;

            const data = {
                workers,
                places,
                assignments: []
            };
            
            const cells = document.querySelectorAll('.time-cell');
            cells.forEach((cell, index) => {
                if (cell.textContent.

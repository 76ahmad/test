<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>מערכת הקצאת עובדים</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2rem;
        }
        
        .header p {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .controls, .instructions {
            padding: 1rem 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        
        .calendar-container {
            overflow-x: auto;
            margin: 2rem;
        }
        
        .calendar-grid {
            display: grid;
            min-width: 800px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .calendar-grid .header-cell, 
        .calendar-grid .name-cell, 
        .calendar-grid .time-cell {
            padding: 1rem;
            border: 1px solid #ccc;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: background 0.2s;
        }
        
        .calendar-grid .time-cell:hover {
            background: #d6f0ff;
        }
        
        .calendar-grid .time-cell.assigned {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #2d2d2d;
            color: white;
            padding: 2rem;
            border-radius: 10px;
            width: 300px;
            max-width: 90%;
        }
        
        .modal-content h3 {
            margin-top: 0;
            text-align: center;
        }
        
        .place-choice {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .place-btn {
            border: 2px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: #ffffff;
            cursor: pointer;
            font-weight: bold;
            color: #333;
        }
        
        .place-btn:hover {
            border-color: #0056b3;
            background: #e2e6ea;
        }
        
        button {
            margin: 0.25rem;
            padding: 0.6rem 1.4rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s, transform 0.1s;
            background: #007bff;
            color: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }
        
        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .header-cell {
            background: #343a40 !important;
            color: #fff !important;
            font-weight: bold;
        }
        
        .header-cell.corner-cell {
            font-size: 0.9em;
        }
        
        .name-cell {
            background: #212529 !important;
            color: #fff !important;
            font-weight: bold;
        }
        
        .place-color-0 { background-color: #d1ecf1 !important; border-color: #0c5460 !important; }
        .place-color-1 { background-color: #d4edda !important; border-color: #155724 !important; }
        .place-color-2 { background-color: #fff3cd !important; border-color: #856404 !important; }
        .place-color-3 { background-color: #f8d7da !important; border-color: #721c24 !important; }
        .place-color-4 { background-color: #e2e3e5 !important; border-color: #6c757d !important; }
        .place-color-5 { background-color: #cfe2ff !important; border-color: #084298 !important; }
        .place-color-6 { background-color: #e8daef !important; border-color: #512e5f !important; }
        
        #assignmentSummary {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            padding: 1rem;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 8px;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.8);
            margin: 2rem;
            border-radius: 12px;
        }
        
        .instructions h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .instructions p {
            color: #666;
            line-height: 1.5;
        }
        
        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .worker-row, .place-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            padding: 0.5rem;
            border-radius: 6px;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .worker-row span, .place-row span {
            font-weight: bold;
        }
        
        .optional-label {
            font-size: 0.85em;
            color: #888;
        }
        
     /* Print styles */
        @page {
            size: A4 landscape;
            margin: 10mm;
        }
        
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 10pt !important;
                color: black !important;
            }
            
            .container {
                box-shadow: none !important;
                background: white !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Hide non-printable elements */
            .header,
            .controls, 
            .instructions,
            #assignmentSummary,
            .modal {
                display: none !important;
            }
            
            .calendar-container {
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
                width: 100% !important;
            }
            
            /* Create table for printing */
            .calendar-grid {
                display: table !important;
                background: white !important;
                border-radius: 0 !important;
                width: 100% !important;
                margin: 0 auto !important;
                padding: 0 !important;
                border-collapse: collapse !important;
                table-layout: fixed !important;
                min-width: unset !important;
            }
            
            /* Create rows structure */
            .calendar-grid .header-cell:first-child {
                display: table-cell !important;
                width: 15% !important;
            }
            
            /* Treat each row of cells as a table row */
            .calendar-grid .header-cell,
            .calendar-grid .name-cell,
            .calendar-grid .time-cell {
                display: inline-table !important;
                border: 1px solid black !important;
                padding: 8px 4px !important;
                vertical-align: middle !important;
                text-align: center !important;
                page-break-inside: avoid !important;
                height: auto !important;
                min-height: 30px !important;
                box-sizing: border-box !important;
                float: none !important;
                position: static !important;
            }
            
            /* Fix grid layout for print */
            .calendar-grid::after {
                content: "";
                display: table;
                clear: both;
            }
            
            /* Headers row */
            .calendar-grid .header-cell {
                background: #343a40 !important;
                color: white !important;
                font-weight: bold !important;
                font-size: 11pt !important;
                white-space: nowrap !important;
                width: calc(85% / 7) !important;
            }
            
            .calendar-grid .header-cell.corner-cell {
                font-size: 10pt !important;
                width: 15% !important;
            }
            
            /* Worker names column */
            .calendar-grid .name-cell {
                background: #212529 !important;
                color: white !important;
                font-weight: bold !important;
                font-size: 10pt !important;
                white-space: nowrap !important;
                width: 15% !important;
                clear: both !important;
            }
            
            /* Time cells */
            .calendar-grid .time-cell {
                background: white !important;
                color: black !important;
                font-size: 9pt !important;
                width: calc(85% / 7) !important;
            }
            
            .calendar-grid .time-cell.assigned {
                font-weight: bold !important;
            }
            
            /* Preserve place colors with stronger specificity */
            .calendar-grid .time-cell.place-color-0 { background-color: #d1ecf1 !important; }
            .calendar-grid .time-cell.place-color-1 { background-color: #d4edda !important; }
            .calendar-grid .time-cell.place-color-2 { background-color: #fff3cd !important; }
            .calendar-grid .time-cell.place-color-3 { background-color: #f8d7da !important; }
            .calendar-grid .time-cell.place-color-4 { background-color: #e2e3e5 !important; }
            .calendar-grid .time-cell.place-color-5 { background-color: #cfe2ff !important; }
            .calendar-grid .time-cell.place-color-6 { background-color: #e8daef !important; }
        }
    </style>

    <!-- SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🏢 מערכת ניהול משמרות</h1>
            <p>ניהול משמרות עובדים ומקומות עבודה</p>
        </div>
        
        <div class="controls">
            <button onclick="saveSchedule()">💾 שמור קובץ</button>
            <input accept=".json" id="fileInput" onchange="loadSchedule(event)" style="display:none" type="file"/>
            <button onclick="document.getElementById('fileInput').click()">📂 טעינה</button>
            <button onclick="showAddPlaceModal()">➕ הוסף מקום</button>
            <button onclick="showAddWorkerModal()">👤 הוסף עובד</button>
            <button onclick="showManagePlacesModal()">⚙️ נהל מקומות</button>
            <button onclick="showManageWorkersModal()">👥 נהל עובדים</button>
            <button class="btn-success" onclick="printSchedule()">🖨️ הדפסה</button>
            <button class="btn-info" onclick="exportToExcel()">📊 יצוא ל-Excel</button>
            <button class="btn-secondary" onclick="clearAssignments()">🗑️ נקה הקצאות</button>
            <button class="btn-secondary" onclick="resetLocalStorage()">🔄 איפוס מערכת</button>
        </div>

        <div class="calendar-container">
            <div class="calendar-grid" id="calendar"></div>
        </div>
        
        <div id="assignmentSummary"></div>

        <div class="instructions">
            <h3>📌 הוראות שימוש</h3>
            <p>לחץ על כל תא לבחירת מקום העבודה. לחץ שוב כדי להסיר הקצאה. השתמש בכפתורים לניהול עובדים ומקומות.</p>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="placeSelectorModal">
        <div class="modal-content">
            <h3>בחר מקום עבודה</h3>
            <div class="place-choice" id="placeChoiceContainer"></div>
            <button class="btn-secondary" onclick="closePlaceSelector()">ביטול</button>
        </div>
    </div>

    <div class="modal" id="addPlaceModal">
        <div class="modal-content">
            <h3>הוסף מקום חדש</h3>
            <input id="newPlaceInput" placeholder="שם המקום" type="text"/>
            <div style="margin-top: 1rem; text-align: center;">
                <button onclick="saveNewPlace()">שמור</button>
                <button class="btn-secondary" onclick="closeAddPlaceModal()">ביטול</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addWorkerModal">
        <div class="modal-content">
            <h3>הוסף עובד חדש</h3>
            <input id="newWorkerInput" placeholder="שם העובד" type="text"/>
            <input id="newWorkerId" placeholder="מספר זהות (אופציונלי)" type="text"/>
            <label class="optional-label">שדה אופציונלי</label>
            <input id="newWorkerPhone" placeholder="מספר טלפון (אופציונלי)" type="text"/>
            <label class="optional-label">שדה אופציונלי</label>
            <div style="margin-top: 1rem; text-align: center;">
                <button onclick="saveNewWorker()">שמור</button>
                <button class="btn-secondary" onclick="closeAddWorkerModal()">ביטול</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editWorkerModal">
        <div class="modal-content">
            <h3>עריכת פרטי עובד</h3>
            <input id="editWorkerName" placeholder="שם העובד" type="text" />
            <input id="editWorkerId" placeholder="מספר זהות (אופציונלי)" type="text" />
            <label class="optional-label">שדה אופציונלי</label>
            <input id="editWorkerPhone" placeholder="מספר טלפון (אופציונלי)" type="text" />
            <label class="optional-label">שדה אופציונלי</label>
            <div style="margin-top: 1rem; text-align: center;">
                <button onclick="saveEditedWorker()">שמור</button>
                <button class="btn-secondary" onclick="closeEditWorkerModal()">ביטול</button>
            </div>
        </div>
    </div>

    <div class="modal" id="managePlacesModal">
        <div class="modal-content">
            <h3>ניהול מקומות</h3>
            <div id="placeListContainer" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn-secondary" onclick="closeManagePlacesModal()">סגור</button>
        </div>
    </div>

    <div class="modal" id="manageWorkersModal">
        <div class="modal-content">
            <h3>ניהול עובדים</h3>
            <div id="workerListContainer" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn-secondary" onclick="closeManageWorkersModal()">סגור</button>
        </div>
    </div>

    <div class="modal" id="workerDetailsModal">
        <div class="modal-content">
            <h3>פרטי עובד</h3>
            <p id="workerDetailsText"></p>
            <button class="btn-secondary" onclick="closeWorkerDetailsModal()">סגור</button>
        </div>
    </div>

    <script>
        // Global variables
        const days = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
        const workers = [];
        const places = [];

        // Calendar generation - UPDATED FUNCTION
        function generateCalendar() {
            const calendar = document.getElementById("calendar");
            calendar.innerHTML = '';
            
            // Set grid columns for screen display
            calendar.style.gridTemplateColumns = `repeat(${days.length + 1}, 1fr)`;

            // Create header row wrapper
            const headerRow = document.createElement('div');
            headerRow.className = 'grid-row';
            
            // Add corner cell with label "עובדים / ימים"
            const cornerCell = createCell('עובדים / ימים', 'header-cell corner-cell');
            headerRow.appendChild(cornerCell);
            calendar.appendChild(cornerCell);
            
            // Add day headers
            days.forEach(day => {
                const dayCell = createCell(day, 'header-cell');
                headerRow.appendChild(dayCell);
                calendar.appendChild(dayCell);
            });

            // Add worker rows
            workers.forEach(worker => {
                // Create row wrapper
                const workerRow = document.createElement('div');
                workerRow.className = 'grid-row';
                
                const name = typeof worker === 'string' ? worker : worker.name;
                const nameCell = createCell(name, 'name-cell');
                nameCell.onclick = () => showWorkerDetails(worker);
                workerRow.appendChild(nameCell);
                calendar.appendChild(nameCell);
                
                // Add time cells for each day
                days.forEach(() => {
                    const cell = createCell('', 'time-cell');
                    cell.onclick = () => {
                        if (cell.textContent.trim()) {
                            clearAssignment(cell);
                        } else {
                            openPlaceSelector(cell);
                        }
                    };
                    workerRow.appendChild(cell);
                    calendar.appendChild(cell);
                });
            });
        }

        function createCell(text, className) {
            const div = document.createElement('div');
            div.className = className;
            div.textContent = text;
            return div;
        }

        // Place selector functions
        function openPlaceSelector(cell) {
            const container = document.getElementById("placeChoiceContainer");
            container.innerHTML = '';
            
            places.forEach((place, index) => {
                const btn = document.createElement('button');
                btn.className = 'place-btn';
                btn.textContent = place;
                btn.onclick = () => {
                    cell.textContent = place;
                    cell.className = 'time-cell assigned place-color-' + (index % 7);
                    closePlaceSelector();
                    autoSaveSchedule();
                    updateAssignmentSummary();
                };
                container.appendChild(btn);
            });
            
            document.getElementById("placeSelectorModal").style.display = 'flex';
        }

        function closePlaceSelector() {
            document.getElementById("placeSelectorModal").style.display = 'none';
        }

        function clearAssignment(cell) {
            cell.textContent = '';
            cell.classList.remove('assigned');
            // Remove all place-color classes
            for (let i = 0; i < 7; i++) {
                cell.classList.remove('place-color-' + i);
            }
            updateAssignmentSummary();
            autoSaveSchedule();
        }

        // Worker management functions
        function showAddWorkerModal() {
            document.getElementById("addWorkerModal").style.display = "flex";
        }

        function closeAddWorkerModal() {
            document.getElementById("addWorkerModal").style.display = "none";
            document.getElementById("newWorkerInput").value = '';
            document.getElementById("newWorkerId").value = '';
            document.getElementById("newWorkerPhone").value = '';
        }

        function saveNewWorker() {
            const nameInput = document.getElementById("newWorkerInput");
            const idInput = document.getElementById("newWorkerId");
            const phoneInput = document.getElementById("newWorkerPhone");
            
            const name = nameInput.value.trim();
            const id = idInput.value.trim();
            const phone = phoneInput.value.trim();
            
            if (name) {
                workers.push({ 
                    name, 
                    id: id || '', 
                    phone: phone || '' 
                });
                closeAddWorkerModal();
                generateCalendar();
                autoSaveSchedule();
            } else {
                alert("נא למלא את שם העובד.");
            }
        }

        function showManageWorkersModal() {
            const container = document.getElementById("workerListContainer");
            container.innerHTML = '';
            
            workers.forEach((worker, index) => {
                const row = document.createElement('div');
                row.className = 'worker-row';
                
                const details = document.createElement('span');
                let workerInfo = `<strong>${worker.name}</strong>`;
                if (worker.id) workerInfo += `<br>זהות: ${worker.id}`;
                if (worker.phone) workerInfo += `<br>📞 ${worker.phone}`;
                details.innerHTML = workerInfo;
                
                const buttons = document.createElement('div');
                buttons.innerHTML = `
                    <button onclick="editWorker(${index})" style="margin: 2px; padding: 4px 8px;">✏️</button>
                    <button class="btn-secondary" onclick="removeWorker(${index})" style="margin: 2px; padding: 4px 8px;">🗑️</button>
                `;

                row.appendChild(details);
                row.appendChild(buttons);
                container.appendChild(row);
            });

            document.getElementById("manageWorkersModal").style.display = 'flex';
        }

        function closeManageWorkersModal() {
            document.getElementById("manageWorkersModal").style.display = "none";
        }

        function removeWorker(index) {
            if (confirm("האם אתה בטוח שתרצה למחוק את העובד הזה?")) {
                workers.splice(index, 1);
                autoSaveSchedule();
                showManageWorkersModal();
                generateCalendar();
            }
        }

        let editingWorkerIndex = null;

        function editWorker(index) {
            const worker = workers[index];
            document.getElementById("editWorkerName").value = worker.name;
            document.getElementById("editWorkerId").value = worker.id || '';
            document.getElementById("editWorkerPhone").value = worker.phone || '';
            editingWorkerIndex = index;
            closeManageWorkersModal();
            document.getElementById("editWorkerModal").style.display = "flex";
        }

        function saveEditedWorker() {
            const name = document.getElementById("editWorkerName").value.trim();
            const id = document.getElementById("editWorkerId").value.trim();
            const phone = document.getElementById("editWorkerPhone").value.trim();

            if (name) {
                workers[editingWorkerIndex] = { 
                    name, 
                    id: id || '', 
                    phone: phone || '' 
                };
                autoSaveSchedule();
                generateCalendar();
                closeEditWorkerModal();
            } else {
                alert("נא למלא את שם העובד.");
            }
        }

        function closeEditWorkerModal() {
            document.getElementById("editWorkerModal").style.display = "none";
            editingWorkerIndex = null;
        }

        function showWorkerDetails(worker) {
            let text;
            if (typeof worker === 'string') {
                text = `<strong>שם:</strong> ${worker}<br><em>אין מידע נוסף</em>`;
            } else {
                text = `<strong>שם:</strong> ${worker.name}`;
                if (worker.id) text += `<br><strong>זהות:</strong> ${worker.id}`;
                if (worker.phone) text += `<br><strong>טלפון:</strong> ${worker.phone}`;
                if (!worker.id && !worker.phone) text += `<br><em>אין מידע נוסף</em>`;
            }
            document.getElementById("workerDetailsText").innerHTML = text;
            document.getElementById("workerDetailsModal").style.display = "flex";
        }

        function closeWorkerDetailsModal() {
            document.getElementById("workerDetailsModal").style.display = "none";
        }

        // Place management functions
        function showAddPlaceModal() {
            document.getElementById("addPlaceModal").style.display = "flex";
        }

        function closeAddPlaceModal() {
            document.getElementById("addPlaceModal").style.display = "none";
            document.getElementById("newPlaceInput").value = '';
        }

        function saveNewPlace() {
            const input = document.getElementById("newPlaceInput");
            const name = input.value.trim();
            if (name) {
                places.push(name);
                closeAddPlaceModal();
                autoSaveSchedule();
            } else {
                alert("נא להזין שם מקום.");
            }
        }

        function showManagePlacesModal() {
            const container = document.getElementById("placeListContainer");
            container.innerHTML = '';
            
            places.forEach((place, index) => {
                const row = document.createElement('div');
                row.className = 'place-row';
                row.innerHTML = `
                    <span>${place}</span>
                    <div>
                        <button onclick="renamePlace(${index})" style="margin: 2px; padding: 4px 8px;">✏️</button>
                        <button class="btn-secondary" onclick="removePlace(${index})" style="margin: 2px; padding: 4px 8px;">🗑️</button>
                    </div>
                `;
                container.appendChild(row);
            });
            
            document.getElementById("managePlacesModal").style.display = 'flex';
        }

        function closeManagePlacesModal() {
            document.getElementById("managePlacesModal").style.display = "none";
        }

        function renamePlace(index) {
            const newName = prompt("הזן שם חדש למקום:", places[index]);
            if (newName) {
                const oldName = places[index];
                places[index] = newName.trim();
                
                // Update all assignments with the old name
                document.querySelectorAll('.time-cell').forEach(cell => {
                    if (cell.textContent.trim() === oldName) {
                        cell.textContent = newName.trim();
                    }
                });
                
                showManagePlacesModal();
                autoSaveSchedule();
                updateAssignmentSummary();
            }
        }

        function removePlace(index) {
            if (confirm("האם אתה בטוח שתרצה למחוק את המקום הזה?")) {
                const placeName = places[index];
                places.splice(index, 1);
                
                // Clear all assignments for this place
                document.querySelectorAll('.time-cell').forEach(cell => {
                    if (cell.textContent.trim() === placeName) {
                        clearAssignment(cell);
                    }
                });
                
                showManagePlacesModal();
                autoSaveSchedule();
                updateAssignmentSummary();
            }
        }

        // Summary and save functions
        function updateAssignmentSummary() {
            const counters = {};
            let total = 0;
            places.forEach(place => counters[place] = 0);

            document.querySelectorAll('.time-cell').forEach(cell => {
                const place = cell.textContent.trim();
                if (place && counters.hasOwnProperty(place)) {
                    counters[place]++;
                    total++;
                }
            });

            let summary = `סה"כ הקצאות: ${total}<br>`;
            for (const [place, count] of Object.entries(counters)) {
                summary += `${place}: ${count} עובדים<br>`;
            }

            document.getElementById('assignmentSummary').innerHTML = summary;
        }

        function autoSaveSchedule() {
            const data = {
                workers,
                places,
                assignments: []
            };
            
            const cells = document.querySelectorAll('.time-cell');
            cells.forEach((cell, index) => {
                if (cell.textContent.trim()) {
                    let colorClass = '';
                    for (let i = 0; i < 7; i++) {
                        if (cell.classList.contains('place-color-' + i)) {
                            colorClass = 'place-color-' + i;
                            break;
                        }
                    }
                    data.assignments.push({ 
                        index, 
                        value: cell.textContent.trim(),
                        colorClass: colorClass 
                    });
                }
            });
            
            localStorage.setItem("scheduleData", JSON.stringify(data));
            updateAssignmentSummary();
        }

        function loadSchedule(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    workers.length = 0;
                    places.length = 0;
                    workers.push(...data.workers);
                    places.push(...data.places);
                    generateCalendar();
                    
                    const cells = document.querySelectorAll('.time-cell');
                    data.assignments.forEach(a => {
                        if (cells[a.index]) {
                            cells[a.index].textContent = a.value;
                            cells[a.index].classList.add('assigned');
                            if (a.colorClass) {
                                cells[a.index].classList.add(a.colorClass);
                            }
                        }
                    });
                    
                    updateAssignmentSummary();
                    autoSaveSchedule();
                    alert("הקובץ נטען בהצלחה!");
                } catch (error) {
                    alert("שגיאה בקריאת הקובץ!");
                }
            };
            reader.readAsText(file);
        }

        function saveSchedule() {
            const fileName = prompt("הזן שם קובץ לשמירה:", "לוח_משמרות.json");
            if (!fileName) return;

            const data = {
                workers,
                places,
                assignments: []
            };
            
            const cells = document.querySelectorAll('.time-cell');
            cells.forEach((cell, index) => {
                if (cell.textContent.trim()) {
                    let colorClass = '';
                    for (let i = 0; i < 7; i++) {
                        if (cell.classList.contains('place-color-' + i)) {
                            colorClass = 'place-color-' + i;
                            break;
                        }
                    }
                    data.assignments.push({ 
                        index, 
                        value: cell.textContent.trim(),
                        colorClass: colorClass 
                    });
                }
            });
            
            const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName.endsWith(".json") ? fileName : fileName + ".json";
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAssignments() {
            document.querySelectorAll('.time-cell').forEach(cell => {
                clearAssignment(cell);
            });
            updateAssignmentSummary();
        }

        function resetLocalStorage() {
            if (confirm("האם אתה בטוח שתרצה למחוק את כל הנתונים?")) {
                localStorage.removeItem("scheduleData");
                location.reload();
            }
        }

        // Print function
        function printSchedule() {
            const summary = document.getElementById('assignmentSummary');
            const originalDisplay = summary.style.display;
            summary.style.display = 'none';
            
            window.print();
            
            summary.style.display = originalDisplay;
        }

        // Export to Excel function
        function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                // Prepare data for the main schedule sheet
                const scheduleData = [];
                const headerRow = ['עובד'];
                days.forEach(day => headerRow.push(day));
                scheduleData.push(headerRow);
                
                // Add worker rows
                const cells = document.querySelectorAll('.time-cell');
                let cellIndex = 0;
                
                workers.forEach(worker => {
                    const row = [typeof worker === 'string' ? worker : worker.name];
                    
                    days.forEach(() => {
                        const cellValue = cells[cellIndex] ? cells[cellIndex].textContent.trim() : '';
                        row.push(cellValue);
                        cellIndex++;
                    });
                    
                    scheduleData.push(row);
                });
                
                // Create worksheet for schedule
                const ws1 = XLSX.utils.aoa_to_sheet(scheduleData);
                const colWidths = [{ wch: 20 }];
                days.forEach(() => colWidths.push({ wch: 15 }));
                ws1['!cols'] = colWidths;
                XLSX.utils.book_append_sheet(wb, ws1, 'לוח משמרות');
                
                // Create summary sheet
                const summaryData = [['מקום', 'מספר עובדים']];
                const counters = {};
                places.forEach(place => counters[place] = 0);
                
                document.querySelectorAll('.time-cell').forEach(cell => {
                    const place = cell.textContent.trim();
                    if (place && counters.hasOwnProperty(place)) {
                        counters[place]++;
                    }
                });
                
                let total = 0;
                for (const [place, count] of Object.entries(counters)) {
                    summaryData.push([place, count]);
                    total += count;
                }
                summaryData.push(['סה"כ', total]);
                
                const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
                ws2['!cols'] = [{ wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws2, 'סיכום');
                
                // Create workers details sheet
                const workersData = [['שם', 'מספר זהות', 'מספר טלפון']];
                workers.forEach(worker => {
                    if (typeof worker === 'string') {
                        workersData.push([worker, '', '']);
                    } else {
                        workersData.push([worker.name, worker.id || '', worker.phone || '']);
                    }
                });
                
                const ws3 = XLSX.utils.aoa_to_sheet(workersData);
                ws3['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws3, 'פרטי עובדים');
                
                // Generate filename with current date
                const now = new Date();
                const dateStr = now.toLocaleDateString('he-IL').replace(/\//g, '-');
                const filename = `לוח_משמרות_${dateStr}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                alert('✅ הקובץ יוצא בהצלחה!');
                
            } catch (error) {
                console.error('Export error:', error);
                alert('❌ אירעה שגיאה בזמן יצוא הקובץ');
            }
        }

        // Initialize on page load
        window.onload = () => {
            const saved = localStorage.getItem("scheduleData");
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    workers.push(...(data.workers || []));
                    places.push(...(data.places || []));
                    generateCalendar();
                    
                    const cells = document.querySelectorAll('.time-cell');
                    if (data.assignments) {
                        data.assignments.forEach(a => {
                            if (cells[a.index]) {
                                cells[a.index].textContent = a.value;
                                cells[a.index].classList.add('assigned');
                                if (a.colorClass) {
                                    cells[a.index].classList.add(a.colorClass);
                                }
                            }
                        });
                    }
                    
                    updateAssignmentSummary();
                } catch (error) {
                    console.error('Error loading saved data:', error);
                    generateCalendar();
                }
            } else {
                generateCalendar();
            }
        };
    </script>
</body>
</html>

